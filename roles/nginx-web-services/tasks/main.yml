---
- name: remove /var/www/html
  become: yes
  ansible.builtin.file:
    path: /var/www/html
    state: absent

- name: ensure {{ web_user_home }} exists and is owned by root
  become: yes
  ansible.builtin.file:
    path: "{{ web_user_home }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: install nginx related software
  become: yes
  ansible.builtin.apt:
    name:
      - nginx-extras
    state: present
  when:
    - web_server_docker is not defined or web_server_docker|bool == false

- name: create some default nginx directories
  become: yes
  ansible.builtin.file:
    path: "/etc/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  loop:
    - nginx
    - nginx/sites-enabled
    - nginx/sites-available
    - nginx/modules-enabled

- name: create nginx eqpress common directory
  become: yes
  ansible.builtin.file:
    path: /etc/nginx/eqpress-common
    state: directory
    mode: 0750
    owner: root
    group: "{{ web_groupname }}"

- name: create nginx log directory
  become: yes
  ansible.builtin.file:
    path: /var/log/nginx
    state: directory
    mode: 0750
    owner: root
    group: "{{ web_groupname }}"
 
- name: remove the default site config
  become: yes
  ansible.builtin.file:
    path: /etc/nginx/sites-available/default
    state: absent

- name: remove default nginx config symlink
  become: yes
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent

- name: create directory ramdisk for nginx cache for tmpfs mount
  become: yes
  ansible.builtin.file:
    path: /var/cache/nginx
    owner: "{{ web_user }}"
    group: root
    state: directory
    mode: 0750

- name: add tmpfs mount to fstab to /var/cache/nginx
  become: yes
  ansible.builtin.lineinfile:
    dest: /etc/fstab
    regexp: "/var/cache/nginx"
    line: "tmpfs /var/cache/nginx tmpfs rw,noexec,nosuid,nodev,mode=0750,uid={{ web_user }} 0 0"
    state: present
  notify:
    - remount

- name: create nginx-ondisk directory
  become: yes
  ansible.builtin.file:
    path: /var/cache/nginx-ondisk
    state: directory
    owner: "{{ web_user }}"
    group: root
    mode: 0750

- name: templates nginx common files
  become: yes
  ansible.builtin.template:
    src: "etc/nginx/{{ item }}.j2"
    dest: "/etc/nginx/{{ item }}"
    owner: root
    group: root
    mode: 0644
  loop:
    - nginx.conf
    - eqpress-common/common_adminer.conf
    - eqpress-common/common_fastcgi.conf
    - eqpress-common/common_headers.conf
    - eqpress-common/common_eqpress_ssl.conf
    - eqpress-common/common_cdn_realip.conf
  tags: cdn

- name: copy nginx common files
  become: yes
  ansible.builtin.copy:
    src: "etc/nginx/{{ item }}"
    dest: "/etc/nginx/{{ item }}"
    owner: root
    group: root
    mode: 0644
  loop:
    - eqpress-common/common_cache.conf
    - eqpress-common/common_exceptions.conf
    - eqpress-common/common_location.conf
    - eqpress-common/common_location_ep.conf
    - eqpress-common/common_log_formats.conf
    - eqpress-common/common_login_limiter.conf
    - eqpress-common/common_mobile_user_agents.conf
    - eqpress-common/common_multisite_3.5.conf
    - eqpress-common/common_w3tc.conf
    - eqpress-common/lua_block_post_noreferrer.lua
    - eqpress-common/lua_block_post_noreferrer_on.lua
    - eqpress-common/lua_block_wplogin_noreferrer.lua

- name: template nginx eqpress config
  become: yes
  ansible.builtin.template:
    src: etc/nginx/sites-available/eqpress.j2
    dest: /etc/nginx/sites-available/eqpress
    owner: root
    group: root
    mode: 0644
    backup: yes
  when: not auto_provision_host | default(false) | bool

- name: template nginx eqpress config provision
  become: yes
  ansible.builtin.template:
    src: etc/nginx/sites-available/eqpress-provision.j2
    dest: /etc/nginx/sites-available/eqpress-provision
    owner: root
    group: root
    mode: 0644
    backup: yes
  when: auto_provision_host | default(false) | bool

- name: link eqpress nginx config provision
  become: yes
  ansible.builtin.file:
    src: /etc/nginx/sites-available/eqpress-provision
    dest: /etc/nginx/sites-enabled/eqpress-provision
    state: link
  when: auto_provision_host | default(false) | bool

- name: link eqpress nginx config
  become: yes
  ansible.builtin.file:
    src: /etc/nginx/sites-available/eqpress
    dest: /etc/nginx/sites-enabled/eqpress
    state: link
  when: not auto_provision_host | default(false) | bool

- name: copy custom logrotate config for nginx access logs
  become: yes
  ansible.builtin.copy:
    src: etc/logrotate.d/nginx
    dest: /etc/logrotate.d
    owner: root
    group: root
    mode: 0644

- name: update nginx open file limits using ulimit in default file
  become: yes
  ansible.builtin.copy:
    src: etc/default/nginx
    dest: /etc/default/nginx
    owner: root
    group: root
    mode: 0644
  when:
    - web_server_docker is not defined or web_server_docker|bool == false

# TODO: setup modules-enabled
# TODO: include docker when web_server_docker: true
# TODO: Add handlers
#

- name: setup docker when web_server_docker
  ansible.builtin.include_tasks: docker.yml
  tags: always
  when: web_server_docker|bool == true

- name: niginx docker when web_server_docker
  ansible.builtin.include_tasks: nginx-docker.yml
  tags: always
  when: web_server_docker|bool == true

- name: ensure nginx will start at boot
  become: yes
  ansible.builtin.systemd:
    name: nginx
    enabled: yes
  when:
    - web_server_docker is not defined or web_server_docker|bool == false

- name: start nginx
  become: yes
  ansible.builtin.service:
    name: nginx
    state: restarted
  when:
    - web_server_docker is not defined or web_server_docker|bool == false
