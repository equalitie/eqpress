# {{ ansible_managed }}
[client-server]
socket                        = {{ mariadb_unix_socket }}

[client]
port                          = {{ mariadb_port }}
socket                        = {{ mariadb_unix_socket }}
ssl-ca                        = /etc/ssl/eqpress/root_CA.pem
ssl-cert                      = /etc/ssl/eqpress/{{ inventory_hostname }}.pem
ssl-key                       = /etc/ssl/eqpress/{{ inventory_hostname }}.key

[mysqld_safe]
nice = 0
skip_log_error
syslog

[server]

# GENERAL #
user                           = mysql
socket                         = {{ mariadb_unix_socket }}
pid-file                       = /run/mysqld/mysqld.pid
default_storage_engine         = InnoDB
tmpdir                         = /tmp
basedir                        = /usr
bind-address                   = {{ mysql_bind_address | default('0.0.0.0') }}
server_id                      = {{ mysql_server_id | default(5) }}
performance_schema             = 0
datadir                        = {{ mariadb_datadir }}
lc-messages-dir                = /usr/share/mysql
lc_messages                    = en_US
skip-external-locking

# MyISAM #
key_buffer_size                = {{ mysql_innodb_log_file_size }}
myisam_recover_options         = FORCE,BACKUP

# SAFETY #
max_allowed_packet             = 16M
max_connect_errors             = 100000

# BINARY LOGGING #
log_bin                        = {{ mariadb_datadir }}/mysql_bin
expire_logs_days               = 4
sync_binlog                    = 0
binlog_format                  = MIXED

# REPLICATION #
read_only                      = {{ mysql_is_read_only | default(0) }}
log_slave_updates              = 1
relay_log                      = {{ mariadb_datadir }}/relay_bin
slave_net_timeout              = 60

# CACHES AND LIMITS #
tmp_table_size                 = 32M
max_heap_table_size            = 32M
query_cache_type               = 0
query_cache_size               = 32M
query_cache_limit              = 256K
max_connections                = 100
thread_cache_size              = 50
open_files_limit               = 65535
table_definition_cache         = 16384
table_open_cache               = 16384
read_buffer_size               = 1M
sort_buffer_size               = 1M
join_buffer_size               = 1M

# INNODB #
innodb_flush_method            = O_DIRECT
innodb_flush_log_at_trx_commit = 1
innodb_file_per_table          = 1
innodb_log_file_size           = {{ mysql_innodb_log_file_size }} 
innodb_buffer_pool_size        = {{ mysql_innodb_buffer_pool_size }} 
innodb_stats_on_metadata       = 0
innodb_read_io_threads         = 64 
innodb_write_io_threads        = 64 
innodb_io_capacity             = 2000

# LOGGING #
log_queries_not_using_indexes  = 1
log_error                      = {{ mariadb_logdir }}/mysql_error.log
slow_query_log                 = 1
slow_query_log_file            = {{ mariadb_logdir }}/mysql_slow.log
# This log is noisy. Good for debugging
general_log                    = 0
general_log_file               = {{ mariadb_logdir }}/mysql.log

# SSL #
ssl-ca                         = /etc/ssl/eqpress/root_CA.pem
ssl-cert                       = /etc/ssl/eqpress/{{ inventory_hostname }}.pem
ssl-key                        = /etc/ssl/eqpress/{{ inventory_hostname }}.key

character-set-server           = utf8mb4
collation-server               = utf8mb4_general_ci

[mariadb]
userstat                       = 1
