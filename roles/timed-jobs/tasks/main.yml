---
- name: copy webstats cron jobs for master
  become: yes
  ansible.builtin.template:
    src: etc/cron.d/eqpress_webstats.j2
    dest: /etc/cron.d/eqpress_webstats
    owner: root
    group: root
    mode: 0640
  when:
    - mysql_repl_role is defined
    - mysql_repl_role == "master"
  tags:
    - timers
    - cron
  notify:
    - "restart cron"

- name: copy backup cron jobs
  become: yes
  ansible.builtin.copy:
    src: "etc/cron.d/backups.{{ mysql_repl_role }}"
    dest: /etc/cron.d/backups
    owner: root
    group: root
    mode: 0640
  when:
    - mysql_repl_role is defined
  tags:
    - timers
    - cron
  notify:
    - "restart cron"

- name: copy system checks cron jobs
  become: yes
  ansible.builtin.copy:
    src: "etc/cron.d/eqpress_system_checks.{{ mysql_repl_role }}"
    dest: /etc/cron.d/eqpress_system_checks
    owner: root
    group: root
    mode: 0640
  when:
    - mysql_repl_role is defined
  tags:
    - timers
    - cron
  notify:
    - "restart cron"

- name: copy cronjob to purge PHP sessions
  become: yes
  ansible.builtin.copy:
    src: etc/cron.d/php
    dest: /etc/cron.d/eqpress_php
    owner: root
    group: root
    mode: 0644
  when:
    - mysql_repl_role is defined
  tags:
    - timers
    - cron
  notify:
    - "restart cron"

- name: install edgespermit service and timer
  become: yes
  ansible.builtin.copy:
    src: "etc/systemd/system/edgespermit.{{ item }}"
    dest: "/etc/systemd/system/edgespermit.{{ item }}"
    owner: root
    group: root
    mode: '0644'
  when: method_allowedges
  loop:
    - timer
    - service
  notify:
    - systemd_daemon_reload
    - systemd_enable_edgespermit_timer
  tags:
    - timers
    - edgespermit
